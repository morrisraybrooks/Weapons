package com.offensive.mobilepentest;

import java.io.*;
import java.net.*;
import java.util.*;
import java.util.concurrent.*;

/**
 * Nmap - A real port scanner implementation for Android
 * Performs TCP connect scanning, service detection, and banner grabbing
 */
public class Nmap {
    
    private int timeout = 3000; // Connection timeout in ms
    private int threadCount = 50; // Number of concurrent scanning threads
    private ExecutorService executor;
    
    public Nmap() {
        this.executor = Executors.newFixedThreadPool(threadCount);
    }
    
    public Nmap(int timeout, int threads) {
        this.timeout = timeout;
        this.threadCount = threads;
        this.executor = Executors.newFixedThreadPool(threadCount);
    }
    
    /**
     * Represents a port with its number and protocol
     */
    public static class PortSpec {
        public final int port;
        public final String protocol;
        
        public PortSpec(int port, String protocol) {
            this.port = port;
            this.protocol = protocol;
        }
    }
    
    /**
     * Scan multiple targets and ports
     */
    public NmapScan scan(List<InetAddress> targets, List<PortSpec> ports) 
            throws InterruptedException, ExecutionException {
        
        long startTime = System.currentTimeMillis();
        NmapScan scan = new NmapScan();
        
        List<Future<NmapHost>> futures = new ArrayList<>();
        
        for (InetAddress target : targets) {
            final InetAddress t = target;
            final List<PortSpec> p = ports;
            futures.add(executor.submit(() -> scanHost(t, p)));
        }
        
        for (Future<NmapHost> future : futures) {
            NmapHost host = future.get();
            scan.addHost(host);
        }
        
        scan.setScanTime(System.currentTimeMillis() - startTime);
        return scan;
    }
    
    /**
     * Scan a single host for open ports
     */
    public NmapHost scanHost(InetAddress target, List<PortSpec> ports) {
        NmapHost host = new NmapHost(target.getHostAddress(), target.getHostName());
        
        for (PortSpec portInfo : ports) {
            NmapPort result = scanPort(target, portInfo.port);
            if (result.isOpen()) {
                host.addPort(result);
            }
        }
        
        host.setUp(true);
        return host;
    }
    
    /**
     * Scan a single port using TCP connect
     */
    public NmapPort scanPort(InetAddress target, int port) {
        NmapPort portResult = new NmapPort(port, "tcp");
        
        try {
            Socket socket = new Socket();
            socket.connect(new InetSocketAddress(target, port), timeout);
            
            portResult.setOpen(true);
            
            // Try to grab banner
            String banner = grabBanner(socket);
            if (banner != null && !banner.isEmpty()) {
                portResult.setBanner(banner);
            }
            
            // Detect service
            String service = detectService(port, banner);
            portResult.setService(service);
            
            socket.close();
            
        } catch (SocketTimeoutException e) {
            portResult.setFiltered(true);
        } catch (IOException e) {
            portResult.setClosed(true);
        }
        
        return portResult;
    }
    
    /**
     * Attempt to grab service banner
     */
    private String grabBanner(Socket socket) {
        try {
            socket.setSoTimeout(2000);
            InputStream in = socket.getInputStream();
            OutputStream out = socket.getOutputStream();
            
            // Some services send banner immediately
            byte[] buffer = new byte[1024];
            int bytesRead = in.read(buffer);
            
            if (bytesRead > 0) {
                return new String(buffer, 0, bytesRead).trim();
            }
            
            // Try sending a probe for HTTP-like services
            out.write("GET / HTTP/1.0\r\n\r\n".getBytes());
            out.flush();
            
            bytesRead = in.read(buffer);
            if (bytesRead > 0) {
                return new String(buffer, 0, bytesRead).trim();
            }
            
        } catch (Exception e) {
            // Banner grab failed
        }
        return null;
    }
    
    /**
     * Detect service based on port and banner
     */
    private String detectService(int port, String banner) {
        // Check banner first
        if (banner != null) {
            String lowerBanner = banner.toLowerCase();
            if (lowerBanner.contains("ssh")) return "ssh";
            if (lowerBanner.contains("http")) return "http";
            if (lowerBanner.contains("ftp")) return "ftp";
            if (lowerBanner.contains("smtp")) return "smtp";
            if (lowerBanner.contains("mysql")) return "mysql";
            if (lowerBanner.contains("postgresql")) return "postgresql";
            if (lowerBanner.contains("apache")) return "http-apache";
            if (lowerBanner.contains("nginx")) return "http-nginx";
            if (lowerBanner.contains("redis")) return "redis";
            if (lowerBanner.contains("mongodb")) return "mongodb";
        }
        
        // Fall back to well-known ports
        switch (port) {
            case 20: return "ftp-data";
            case 21: return "ftp";
            case 22: return "ssh";
            case 23: return "telnet";
            case 25: return "smtp";
            case 53: return "dns";
            case 80: return "http";
            case 110: return "pop3";
            case 143: return "imap";
            case 443: return "https";
            case 445: return "microsoft-ds";
            case 993: return "imaps";
            case 995: return "pop3s";
            case 1433: return "mssql";
            case 1521: return "oracle";
            case 3306: return "mysql";
            case 3389: return "rdp";
            case 4444: return "metasploit";
            case 5432: return "postgresql";
            case 5555: return "adb";
            case 5900: return "vnc";
            case 6379: return "redis";
            case 8080: return "http-proxy";
            case 8443: return "https-alt";
            case 27017: return "mongodb";
            default: return "unknown";
        }
    }
    
    /**
     * Shutdown the executor
     */
    public void shutdown() {
        executor.shutdown();
    }
    
    public void setTimeout(int timeout) {
        this.timeout = timeout;
    }
    
    public int getTimeout() {
        return timeout;
    }
}
